<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contestações | New Nerd</title>
    <link rel="stylesheet" href="css/aluno.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <nav class="navbar">
      <div class="nav-content">
        <div class="nav-user">
          <button
            class="btn-logout"
            onclick="window.location.href='painel.html'"
            style="margin-right: 15px"
          >
            ← Voltar ao Painel
          </button>
          <h2>⚠️ Central de Contestações</h2>
        </div>
        <div class="nav-user">
          <span style="font-weight: 600" id="alunoNome">Carregando...</span>
        </div>
      </div>
    </nav>

    <div class="container">
      <div class="painel-header" style="margin-top: 30px">
        <h1>Minhas Contestações</h1>
        <p>
          Não concorda com uma nota ou gabarito? Envie sua justificativa aqui.
        </p>
      </div>

      <div style="max-width: 800px; margin: 0 auto">
        <div class="card-nova-contestacao">
          <h2>Nova Contestação</h2>
          <form id="form-contestacao">
            <div class="form-group">
              <label for="select-questao"
                >Qual questão você quer contestar?</label
              >
              <select id="select-questao" class="form-select" required>
                <option value="">Carregando suas respostas recentes...</option>
              </select>
            </div>

            <div class="form-group">
              <label for="texto-justificativa">Sua Justificativa</label>
              <textarea
                id="texto-justificativa"
                class="form-textarea"
                placeholder="Explique detalhadamente o motivo da contestação. Ex: O gabarito marca A, mas a referência X diz que é B..."
                required
              ></textarea>
            </div>

            <button type="submit" class="btn-login" style="margin-top: 10px">
              Enviar para Análise
            </button>
          </form>
          <div id="form-feedback" class="error" style="margin-top: 15px"></div>
        </div>

        <div class="historico-container">
          <h2
            class="section-title"
            style="border: none; text-align: left; padding-left: 0"
          >
            Histórico de Solicitações
          </h2>
          <div id="contestacoes-list" class="contestacao-list">
            <div
              style="
                text-align: center;
                padding: 40px;
                color: var(--text-muted);
              "
            >
              Carregando histórico...
            </div>
          </div>
        </div>
      </div>
    </div>

    <button
      id="themeToggle"
      class="theme-toggle"
      type="button"
      title="Alternar tema"
    ></button>
    <script src="js/theme.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.local.js"></script>
    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>

    <script>
      // --- Lógica da Página de Contestações ---

      document.addEventListener("DOMContentLoaded", async () => {
        const user = await verificarAuth();
        if (!user) return;

        document.getElementById("alunoNome").textContent =
          user.nome || user.email || "Aluno";

        await carregarQuestoesParaContestar(user.id);
        await carregarContestacoes(user.id);

        // Integração: Verifica se veio redirecionado da tela de resultados
        verificarParametroUrl();

        document
          .getElementById("form-contestacao")
          .addEventListener("submit", (e) => {
            e.preventDefault();
            enviarContestacao(user.id);
          });
      });

      function verificarParametroUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const respostaId = urlParams.get("resposta_id");
        if (respostaId) {
          const select = document.getElementById("select-questao");
          select.value = respostaId;
          if (select.value === respostaId) {
            document.getElementById("texto-justificativa").focus();
          }
        }
      }

      async function carregarQuestoesParaContestar(alunoId) {
        const select = document.getElementById("select-questao");
        try {
          const { data, error } = await window.supabaseClient
            .from("respostas_alunos")
            .select("id, created_at, questoes_geradas (id, enunciado)")
            .eq("aluno_id", alunoId)
            .order("created_at", { ascending: false })
            .limit(50);

          if (error) throw error;

          if (!data || data.length === 0) {
            select.innerHTML =
              '<option value="">Nenhuma questão respondida encontrada</option>';
            return;
          }

          select.innerHTML =
            '<option value="">-- Selecione uma questão --</option>';

          data.forEach((resposta) => {
            if (resposta.questoes_geradas) {
              const option = document.createElement("option");
              option.value = resposta.id;
              const dataFormatada = new Date(
                resposta.created_at
              ).toLocaleDateString("pt-BR");
              const textoEnunciado =
                resposta.questoes_geradas.enunciado.substring(0, 60);
              option.textContent = `${dataFormatada} - ${textoEnunciado}...`;
              select.appendChild(option);
            }
          });
        } catch (err) {
          console.error("Erro load questoes:", err);
          select.innerHTML = '<option value="">Erro ao carregar lista</option>';
        }
      }

      async function enviarContestacao(alunoId) {
        const respostaId = document.getElementById("select-questao").value;
        const texto = document.getElementById("texto-justificativa").value;
        const feedbackEl = document.getElementById("form-feedback");
        const btn = document.querySelector("button[type='submit']");

        feedbackEl.className = "error";
        feedbackEl.style.display = "none";

        if (!respostaId || !texto.trim()) {
          feedbackEl.textContent =
            "Selecione a questão e escreva a justificativa.";
          feedbackEl.classList.add("active");
          return;
        }

        try {
          btn.disabled = true;
          btn.textContent = "Enviando...";

          const { error } = await window.supabaseClient
            .from("contestacoes")
            .insert({
              aluno_id: alunoId,
              resposta_id: respostaId,
              texto_contestacao: texto,
              status: "pendente",
            });

          if (error) throw error;

          feedbackEl.textContent = "Contestação enviada com sucesso!";
          feedbackEl.style.display = "block";
          feedbackEl.style.background = "var(--success-bg)";
          feedbackEl.style.color = "var(--success-color)";

          document.getElementById("form-contestacao").reset();
          await carregarContestacoes(alunoId);
        } catch (err) {
          console.error("Erro envio:", err);
          feedbackEl.textContent = "Erro ao enviar. Tente novamente.";
          feedbackEl.classList.add("active");
        } finally {
          btn.disabled = false;
          btn.textContent = "Enviar para Análise";
        }
      }

      async function carregarContestacoes(alunoId) {
        const list = document.getElementById("contestacoes-list");

        try {
          const { data: contestacoes, error } = await window.supabaseClient
            .from("contestacoes")
            .select(
              `id, resposta_id, texto_contestacao, status, resposta_professor, created_at`
            )
            .eq("aluno_id", alunoId)
            .order("created_at", { ascending: false });

          if (error) throw error;

          if (!contestacoes || contestacoes.length === 0) {
            list.innerHTML =
              '<div style="text-align: center; color: var(--text-muted); padding: 30px;">Você ainda não tem contestações.</div>';
            return;
          }

          const idsRespostas = contestacoes.map((c) => c.resposta_id);
          let mapaEnunciados = {};

          if (idsRespostas.length > 0) {
            const { data: resps } = await window.supabaseClient
              .from("respostas_alunos")
              .select("id, questoes_geradas(enunciado)")
              .in("id", idsRespostas);
            if (resps) {
              resps.forEach((r) => {
                if (r.questoes_geradas)
                  mapaEnunciados[r.id] = r.questoes_geradas.enunciado;
              });
            }
          }

          list.innerHTML = contestacoes
            .map((c) => {
              const statusClass = c.status;
              const statusLabel =
                c.status === "pendente" ? "Em Análise" : c.status;
              const enunciado = mapaEnunciados[c.resposta_id]
                ? mapaEnunciados[c.resposta_id].substring(0, 90) + "..."
                : "Questão não localizada";
              const dataEnvio = new Date(c.created_at).toLocaleDateString(
                "pt-BR"
              );

              return `
              <div class="contestacao-card ${statusClass}">
                <div class="c-header">
                  <div>
                    <h3>${escapeHtml(enunciado)}</h3>
                    <span class="c-date">Enviado em: ${dataEnvio}</span>
                  </div>
                  <span class="status-badge ${statusClass}">${statusLabel}</span>
                </div>
                <div class="c-body">
                  <div class="c-box">
                    <strong>Sua justificativa:</strong>
                    <p>${escapeHtml(c.texto_contestacao)}</p>
                  </div>
                  ${
                    c.resposta_professor
                      ? `
                    <div class="c-box c-resposta-prof">
                      <strong>Resposta do Professor:</strong>
                      <p>${escapeHtml(c.resposta_professor)}</p>
                    </div>`
                      : ""
                  }
                </div>
              </div>`;
            })
            .join("");
        } catch (err) {
          console.error(err);
          list.innerHTML =
            '<p style="color:var(--error-color)">Erro ao carregar histórico.</p>';
        }
      }

      function escapeHtml(text) {
        if (!text) return "";
        return text
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
    </script>
  </body>
</html>
